<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Parallelogram ‚Äî —Å–≤–µ—Ä—Ö–±–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–µ–±‚Äë–º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä (E2EE)</title>
  <meta name="description" content="Parallelogram: end‚Äëto‚Äëend —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ, peer‚Äëto‚Äëpeer —á–µ—Ä–µ–∑ WebRTC —Å —Ä—É—á–Ω—ã–º –æ–±–º–µ–Ω–æ–º SDP, –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ–π—Ñ –¥–ª—è –∑–∞–º–µ—Ç–æ–∫." />
  <style>
    :root{
      --bg:#0b0e13;--panel:#121826;--panel-2:#0e1420;--accent:#6ee7ff;--accent-2:#9b8cff;--text:#e6edf7;--muted:#96a1b3;--danger:#ff6b6b;--ok:#4ade80;
      --border:rgba(255,255,255,.08);--shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 800px at 80% -10%, rgba(110,231,255,.12), transparent 60%),
                     radial-gradient(900px 600px at -10% 120%, rgba(155,140,255,.12), transparent 60%),
                     var(--bg);color:var(--text);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"}
    .app{display:grid;grid-template-columns:320px 1fr 360px;grid-template-rows:auto 1fr;gap:0;height:100vh}
    header{grid-column:1/4;display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.02), transparent);backdrop-filter:saturate(120%) blur(6px);position:sticky;top:0;z-index:2}
    header h1{margin:0;font-size:16px;letter-spacing:.3px;display:flex;align-items:center;gap:10px}
    header h1 .dot{display:inline-block;width:10px;height:10px;border-radius:50%;background:var(--ok);box-shadow:0 0 12px var(--ok)}
    header .actions{display:flex;gap:10px}
    .btn{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:12px;cursor:pointer}
    .btn:hover{border-color:rgba(255,255,255,.15)}
    .btn.primary{background:linear-gradient(180deg, rgba(110,231,255,.18), rgba(110,231,255,.06));border-color:rgba(110,231,255,.35)}
    .btn.danger{background:linear-gradient(180deg, rgba(255,107,107,.18), rgba(255,107,107,.06));border-color:rgba(255,107,107,.35)}

    .sidebar{border-right:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--panel);display:flex;flex-direction:column;min-width:300px}
    .sidebar .search{padding:12px;border-bottom:1px solid var(--border)}
    .input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--panel-2);color:var(--text)}
    .list{overflow:auto}
    .chat-item{display:flex;gap:10px;padding:12px;border-bottom:1px solid var(--border);cursor:pointer}
    .chat-item:hover{background:rgba(255,255,255,.03)}
    .avatar{width:36px;height:36px;border-radius:11px;background:linear-gradient(45deg, var(--accent), var(--accent-2));box-shadow:inset 0 0 0 2px rgba(255,255,255,.08)}
    .meta{display:flex;flex-direction:column;gap:3px;flex:1}
    .row{display:flex;justify-content:space-between;gap:8px}
    .name{font-weight:600}
    .preview{color:var(--muted);font-size:12px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .badge{background:var(--danger);padding:0 6px;border-radius:8px;font-size:11px}

    .chat{display:flex;flex-direction:column;height:100%;}
    .chat-header{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .safety{color:var(--muted);font-size:12px}
    .msgs{flex:1;overflow:auto;padding:18px;display:flex;flex-direction:column;gap:10px}
    .bubble{max-width:70%;padding:10px 12px;border-radius:12px;box-shadow:var(--shadow)}
    .me{align-self:flex-end;background:linear-gradient(180deg, rgba(110,231,255,.18), rgba(110,231,255,.06));border:1px solid rgba(110,231,255,.25)}
    .them{align-self:flex-start;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));border:1px solid var(--border)}
    .time{display:block;color:var(--muted);font-size:11px;margin-top:6px}
    .composer{display:flex;gap:10px;padding:12px;border-top:1px solid var(--border)}
    .composer textarea{flex:1;min-height:46px;max-height:150px;resize:vertical}

    .right{border-left:1px solid var(--border);background:linear-gradient(180deg, rgba(255,255,255,.02), transparent), var(--panel);display:flex;flex-direction:column}
    .card{padding:14px 14px;border-bottom:1px solid var(--border)}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;}
    .hint{font-size:12px;color:var(--muted)}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .hidden{display:none}
    .ok{color:var(--ok)}
    .danger{color:var(--danger)}

    @media (max-width:1100px){.app{grid-template-columns: 1fr}.sidebar{display:none}.right{display:none}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1><span class="dot" id="status-dot"></span> Parallelogram ‚Äî E2EE</h1>
      <div class="actions">
        <button class="btn" id="btn-export-pub">–ü–æ–∫–∞–∑–∞—Ç—å –º–æ–π –ø—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á</button>
        <button class="btn primary" id="btn-new-session">–ù–æ–≤–∞—è P2P‚Äë—Å–µ—Å—Å–∏—è</button>
        <button class="btn danger" id="btn-lock">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
    </header>

    <!-- –ß–ê–¢‚Äë–õ–ò–°–¢ -->
    <aside class="sidebar">
      <div class="search"><input class="input" id="search" placeholder="–ü–æ–∏—Å–∫‚Ä¶" /></div>
      <div class="list" id="chat-list"></div>
    </aside>

    <!-- –û–°–ù–û–í–ù–û–ô –ß–ê–¢ -->
    <main class="chat">
      <div class="chat-header">
        <div>
          <div id="chat-title" class="name">–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è</div>
          <div class="safety">–ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π –æ—Ç–ø–µ—á–∞—Ç–æ–∫: <span id="safety-num" class="mono">‚Äî</span></div>
        </div>
        <div class="safety" id="rtc-state">WebRTC: ‚Äî</div>
      </div>
      <div class="msgs" id="msgs"></div>
      <div class="composer">
        <textarea class="input" id="msg-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ‚Ä¶ (—à–∏—Ñ—Ä—É–µ—Ç—Å—è –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ)" disabled></textarea>
        <button class="btn primary" id="btn-send" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </main>

    <!-- –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨: –∫–ª—é—á–∏, —Å–∏–≥–Ω–∞–ª–∏–Ω–≥, —Å–µ–π—Ñ -->
    <aside class="right">
      <div class="card">
        <h3>üîê –ö–ª—é—á —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏</h3>
        <div class="hint">–°–æ–∑–¥–∞—ë—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ. –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω –ø–∞—Ä–æ–ª–µ–º.</div>
        <div class="grid" style="margin-top:8px">
          <input id="alias" class="input" placeholder="–í–∞—à –ø—Å–µ–≤–¥–æ–Ω–∏–º" />
          <input id="pass" class="input" type="password" placeholder="–ü–∞—Ä–æ–ª—å –¥–ª—è –∫–ª—é—á–∞" />
        </div>
        <div class="grid" style="margin-top:8px">
          <button class="btn" id="btn-gen">–°–æ–∑–¥–∞—Ç—å –∫–ª—é—á</button>
          <button class="btn" id="btn-unlock">–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>
        </div>
        <div class="hint" id="key-status" style="margin-top:8px">–°—Ç–∞—Ç—É—Å: –Ω–µ—Ç –∫–ª—é—á–∞</div>
      </div>

      <div class="card">
        <h3>üåê –†—É—á–Ω–æ–π –æ–±–º–µ–Ω SDP (WebRTC P2P)</h3>
        <div class="hint">–ù–∏–∫–∞–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç–∞. –í—Å—Ç–∞–≤—å—Ç–µ –æ—Ñ—Ñ–µ—Ä/—ç–Ω—Å–µ—Ä –≤ –ø–æ–ª—è –Ω–∏–∂–µ, —á—Ç–æ–±—ã —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –Ω–∞–ø—Ä—è–º—É—é.</div>
        <div style="margin-top:8px">
          <button class="btn" id="btn-create-offer">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ñ—Ñ–µ—Ä</button>
          <button class="btn" id="btn-apply-answer">–ü—Ä–∏–º–µ–Ω–∏—Ç—å answer</button>
        </div>
        <textarea id="offer-out" class="input mono" style="margin-top:8px;height:120px" placeholder="–ó–¥–µ—Å—å –ø–æ—è–≤–∏—Ç—Å—è JSON‚Äë–æ—Ñ—Ñ–µ—Ä (—Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫—É)"></textarea>
        <textarea id="answer-in" class="input mono" style="margin-top:8px;height:120px" placeholder="–í—Å—Ç–∞–≤—å—Ç–µ JSON‚Äëanswer –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ –∏ –Ω–∞–∂–º–∏—Ç–µ ‚Äò–ü—Ä–∏–º–µ–Ω–∏—Ç—å answer‚Äô"></textarea>
        <hr style="border:none;border-top:1px solid var(--border);margin:12px 0" />
        <textarea id="offer-in" class="input mono" style="margin-top:8px;height:120px" placeholder="–ï—Å–ª–∏ –≤—ã –≤—Ç–æ—Ä–æ–π —É—á–∞—Å—Ç–Ω–∏–∫: –≤—Å—Ç–∞–≤—å—Ç–µ JSON‚Äëoffer –æ—Ç —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞ —Å—é–¥–∞"></textarea>
        <div style="margin-top:8px">
          <button class="btn" id="btn-accept-offer">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∏ –ø–æ–∫–∞–∑–∞—Ç—å answer</button>
        </div>
        <textarea id="answer-out" class="input mono" style="margin-top:8px;height:120px" placeholder="–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç JSON‚Äëanswer –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–º—É —É—á–∞—Å—Ç–Ω–∏–∫—É"></textarea>
      </div>

      <div class="card">
        <h3>üß∞ –°–µ–π–≤‚Äë—á–∞—Ç (–ª–æ–∫–∞–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏)</h3>
        <div class="hint">–®–∏—Ñ—Ä—É–µ—Ç—Å—è –≤–∞—à–∏–º –ø–∞—Ä–æ–ª–µ–º, —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ.</div>
        <input id="note-title" class="input" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" style="margin-top:8px" />
        <textarea id="note-body" class="input" style="height:100px;margin-top:8px" placeholder="–¢–µ–∫—Å—Ç"></textarea>
        <div class="grid" style="margin-top:8px">
          <button class="btn" id="btn-save-note">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
          <button class="btn danger" id="btn-clear-notes">–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ</button>
        </div>
        <div id="notes" style="margin-top:8px"></div>
      </div>

      <div class="card">
        <h3>‚ÑπÔ∏è –ó–∞–º–µ—á–∞–Ω–∏—è –ø–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</h3>
        <ul class="hint">
          <li>–ö–æ–Ω—Ç–µ–Ω—Ç —à–∏—Ñ—Ä—É–µ—Ç—Å—è <em>–¥–æ</em> –æ—Ç–ø—Ä–∞–≤–∫–∏ (AES‚ÄëGCM 256). –ö–ª—é—á –≤—ã—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –∏–∑ ECDH(P‚Äë256) ‚Üí HKDF.</li>
          <li>WebRTC –∫–∞–Ω–∞–ª —à–∏—Ñ—Ä—É–µ—Ç—Å—è DTLS, –Ω–æ –º—ã –¥–æ–±–∞–≤–ª—è–µ–º —Å–≤–æ—ë E2EE –ø–æ–≤–µ—Ä—Ö (–¥–≤–æ–π–Ω–∞—è –∑–∞—â–∏—Ç–∞).</li>
          <li>–î–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –∑–∞ NAT –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ TURN‚Äë—Å–µ—Ä–≤–µ—Ä (–º–æ–∂–Ω–æ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ø–æ–∑–∂–µ).</li>
          <li>–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ ¬´–æ—Ç–ø–µ—á–∞—Ç–æ–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏¬ª –ø–æ –≥–æ–ª–æ—Å—É/–≤—Å—Ç—Ä–µ—á–µ.</li>
        </ul>
      </div>
    </aside>
  </div>

<script>
// ========= –£–¢–ò–õ–ò–¢–´ =========
const $ = (id)=>document.getElementById(id);
const enc = new TextEncoder();
const dec = new TextDecoder();

const b64u = {
  enc: (buf)=>{
    let bin = Array.from(new Uint8Array(buf), x=>String.fromCharCode(x)).join("");
    return btoa(bin).replaceAll('+','-').replaceAll('/','_').replace(/=+$/,'');
  },
  dec: (str)=>{
    str = str.replaceAll('-','+').replaceAll('_','/');
    const pad = str.length%4===2? '==': str.length%4===3? '=': '';
    const bin = atob(str+pad);
    const arr = new Uint8Array(bin.length);
    for(let i=0;i<bin.length;i++) arr[i]=bin.charCodeAt(i);
    return arr.buffer;
  }
};

async function sha256(buf){
  return await crypto.subtle.digest('SHA-256', buf);
}

function hex(bytes){
  return [...new Uint8Array(bytes)].map(b=>b.toString(16).padStart(2,'0')).join('');
}

function chunk(str,size){
  const out=[];for(let i=0;i<str.length;i+=size) out.push(str.slice(i,i+size));return out.join(' ');
}

// ========= –•–†–ê–ù–ò–õ–ò–©–ï =========
const store = {
  get(k){try{return JSON.parse(localStorage.getItem(k));}catch{return null}},
  set(k,v){localStorage.setItem(k, JSON.stringify(v))},
  del(k){localStorage.removeItem(k)}
};

// ========= –ö–õ–Æ–ß–ò –£–ß–Å–¢–ö–ò =========
const KEY_SLOT = 'pg.account'; // { alias, pubJwk, privWrapped, salt, iv }
let account = null; // {pubKey, privKey, alias, pubJwk, rk?}

async function deriveKEK(password, salt){
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveKey']);
  return await crypto.subtle.deriveKey({name:'PBKDF2', hash:'SHA-256', salt, iterations:200000}, baseKey, {name:'AES-GCM', length:256}, false, ['wrapKey','unwrapKey']);
}

async function createAccount(){
  const alias = $('alias').value.trim() || 'user';
  const pwd = $('pass').value;
  if(pwd.length<6){alert('–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (‚â•6)');return}
  const keyPair = await crypto.subtle.generateKey({name:'ECDH', namedCurve:'P-256'}, true, ['deriveBits']);
  const pubJwk = await crypto.subtle.exportKey('jwk', keyPair.publicKey);
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const kek = await deriveKEK(pwd, salt);
  const privWrapped = await crypto.subtle.wrapKey('jwk', keyPair.privateKey, kek, {name:'AES-GCM', iv});
  store.set(KEY_SLOT, {alias, pubJwk, privWrapped:b64u.enc(privWrapped), salt:b64u.enc(salt), iv:b64u.enc(iv)});
  $('key-status').textContent = '–ö–ª—é—á —Å–æ–∑–¥–∞–Ω –∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω';
}

async function unlockAccount(){
  const data = store.get(KEY_SLOT);
  if(!data){alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –∫–ª—é—á');return}
  const pwd = $('pass').value; if(!pwd){alert('–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å');return}
  const kek = await deriveKEK(pwd, b64u.dec(data.salt));
  const privKey = await crypto.subtle.unwrapKey('jwk', b64u.dec(data.privWrapped), kek, {name:'AES-GCM', iv: b64u.dec(data.iv)}, {name:'ECDH', namedCurve:'P-256'}, true, ['deriveBits']);
  const pubKey = await crypto.subtle.importKey('jwk', data.pubJwk, {name:'ECDH', namedCurve:'P-256'}, true, []);
  account = { alias: data.alias, pubKey, privKey, pubJwk: data.pubJwk };
  $('key-status').textContent = '–ö–ª—é—á —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω';
  updateStatus();
}

$('btn-gen').onclick = createAccount;
$('btn-unlock').onclick = unlockAccount;
$('btn-lock').onclick = ()=>{account=null; $('key-status').textContent='–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ'; updateStatus();};

$('btn-export-pub').onclick = async ()=>{
  if(!account){alert('–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –∫–ª—é—á');return}
  const pub = JSON.stringify(account.pubJwk);
  await navigator.clipboard.writeText(pub);
  alert('–ü—É–±–ª–∏—á–Ω—ã–π –∫–ª—é—á —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞');
};

// ========= –î–ï–†–ò–í–ê–¶–ò–Ø –°–ï–°–°–ò–ò =========
let session = null; // {peerPubJwk, peerPubKey, rootKeyRaw(ArrayBuffer), counter}

async function deriveShared(peerPubJwk){
  const peerPubKey = await crypto.subtle.importKey('jwk', peerPubJwk, {name:'ECDH', namedCurve:'P-256'}, true, []);
  const secret = await crypto.subtle.deriveBits({name:'ECDH', public: peerPubKey}, account.privKey, 256);
  // salt = SHA256(sorted(pubX))
  const myPub = enc.encode(JSON.stringify(account.pubJwk));
  const theirPub = enc.encode(JSON.stringify(peerPubJwk));
  const cat = new Uint8Array(myPub.byteLength + theirPub.byteLength);
  if(b64u.enc(myPub) < b64u.enc(theirPub)) {cat.set(new Uint8Array(myPub),0);cat.set(new Uint8Array(theirPub),myPub.byteLength);} else {cat.set(new Uint8Array(theirPub),0);cat.set(new Uint8Array(myPub),theirPub.byteLength);}
  const salt = await sha256(cat.buffer);
  // HKDF extract+expand to 32 bytes root key
  const base = await crypto.subtle.importKey('raw', secret, 'HKDF', false, ['deriveBits']);
  const rk = await crypto.subtle.deriveBits({name:'HKDF', hash:'SHA-256', salt, info: enc.encode('parallelogram-v1')}, base, 256);
  session = { peerPubJwk, peerPubKey, rootKeyRaw: rk, counter: 0, salt };
  // safety number
  const safety = await sha256(cat.buffer);
  const fpr = chunk(hex(safety).slice(0,40), 8);
  $('safety-num').textContent = fpr;
}

async function deriveMsgKey(i){
  const base = await crypto.subtle.importKey('raw', session.rootKeyRaw, 'HKDF', false, ['deriveKey']);
  return await crypto.subtle.deriveKey({name:'HKDF', hash:'SHA-256', salt: session.salt, info: enc.encode('msg-'+i)}, base, {name:'AES-GCM', length:256}, false, ['encrypt','decrypt']);
}

async function encryptMessage(plain){
  const i = ++session.counter;
  const key = await deriveMsgKey(i);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(plain));
  return { c: b64u.enc(ct), n: b64u.enc(iv), i };
}

async function decryptMessage(env){
  const key = await deriveMsgKey(env.i);
  const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv: b64u.dec(env.n)}, key, b64u.dec(env.c));
  return dec.decode(pt);
}

// ========= WEBRTC (—Ä—É—á–Ω–æ–π –æ–±–º–µ–Ω) =========
let pc=null, dc=null;
function resetRTC(){ if(pc){ pc.close(); pc=null; } dc=null; $('rtc-state').textContent='WebRTC: ‚Äî'; }

function updateStatus(){
  $('status-dot').style.background = account? 'var(--ok)':'#666';
  $('msg-input').disabled = !dc || dc.readyState!=='open';
  $('btn-send').disabled = !dc || dc.readyState!=='open';
  $('chat-title').textContent = dc && dc.readyState==='open' ? '–°–æ–µ–¥–∏–Ω–µ–Ω–æ' : '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è';
}

function onChannel(channel){
  dc = channel;
  dc.onopen = ()=>{ $('rtc-state').textContent='WebRTC: datachannel open'; $('msg-input').disabled=false; $('btn-send').disabled=false; };
  dc.onclose = ()=>{ $('rtc-state').textContent='WebRTC: –∑–∞–∫—Ä—ã—Ç–æ'; updateStatus(); };
  dc.onmessage = async (ev)=>{
    try{
      const env = JSON.parse(ev.data);
      const text = await decryptMessage(env);
      addMsg(text, false);
    }catch(e){ console.error('recv err', e); }
  };
  updateStatus();
}

$('btn-new-session').onclick = ()=>{ resetRTC(); startOfferFlow(); };

async function startOfferFlow(){
  if(!account){alert('–°–Ω–∞—á–∞–ª–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –∫–ª—é—á');return}
  pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
  onChannel(pc.createDataChannel('pg-chat', {ordered:true}))
  pc.onicegatheringstatechange = ()=>{ $('rtc-state').textContent = 'ICE: '+pc.iceGatheringState; };
  pc.onconnectionstatechange = ()=>{ $('rtc-state').textContent = 'State: '+pc.connectionState; };
  await pc.setLocalDescription(await pc.createOffer());
  // –∂–¥—ë–º ICE gathering complete
  await new Promise(r=>{ if(pc.iceGatheringState==='complete') return r(); pc.addEventListener('icegatheringstatechange',()=> pc.iceGatheringState==='complete' && r()); });
  const offer = { sdp: pc.localDescription, pub: account.pubJwk, alias: account.alias };
  $('offer-out').value = JSON.stringify(offer);
}

$('btn-apply-answer').onclick = async ()=>{
  if(!pc){alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –æ—Ñ—Ñ–µ—Ä');return}
  try{
    const ans = JSON.parse($('answer-in').value);
    await pc.setRemoteDescription(ans.sdp);
    await deriveShared(ans.pub);
    updateStatus();
  }catch(e){ alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π answer'); }
};

$('btn-accept-offer').onclick = async ()=>{
  if(!account){alert('–†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –∫–ª—é—á');return}
  try{
    const off = JSON.parse($('offer-in').value);
    pc = new RTCPeerConnection({iceServers:[{urls:'stun:stun.l.google.com:19302'}]});
    pc.ondatachannel = (e)=> onChannel(e.channel);
    pc.onicegatheringstatechange = ()=>{ $('rtc-state').textContent = 'ICE: '+pc.iceGatheringState; };
    pc.onconnectionstatechange = ()=>{ $('rtc-state').textContent = 'State: '+pc.connectionState; };
    await pc.setRemoteDescription(off.sdp);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    await new Promise(r=>{ if(pc.iceGatheringState==='complete') return r(); pc.addEventListener('icegatheringstatechange',()=> pc.iceGatheringState==='complete' && r()); });
    $('answer-out').value = JSON.stringify({ sdp: pc.localDescription, pub: account.pubJwk, alias: account.alias });
    await deriveShared(off.pub);
    updateStatus();
  }catch(e){ alert('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π offer'); console.error(e); }
};

// ========= –°–û–û–ë–©–ï–ù–ò–Ø =========
function addMsg(text, mine){
  const el = document.createElement('div');
  el.className = 'bubble '+(mine?'me':'them');
  el.innerHTML = `${text.replace(/</g,'&lt;')}` + `<span class="time">${new Date().toLocaleTimeString()}</span>`;
  $('msgs').appendChild(el); $('msgs').scrollTop = $('msgs').scrollHeight;
}

$('btn-send').onclick = async ()=>{
  const t = $('msg-input').value.trim(); if(!t) return;
  if(!dc || dc.readyState!=='open'){ alert('–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è'); return }
  try{
    const env = await encryptMessage(t);
    dc.send(JSON.stringify(env));
    addMsg(t, true);
    $('msg-input').value='';
  }catch(e){ alert('–û—à–∏–±–∫–∞ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—è/–æ—Ç–ø—Ä–∞–≤–∫–∏'); console.error(e); }
};

// ========= –°–ï–ô–§‚Äë–ó–ê–ú–ï–¢–ö–ò =========
const NOTE_SLOT='pg.notes';
function listNotes(){
  const box=$('notes'); box.innerHTML='';
  const arr = store.get(NOTE_SLOT)||[];
  for(const n of arr){
    const d=document.createElement('div');
    d.className='hint';
    d.innerHTML = `<div class="mono">${n.title}</div><div>${n.body}</div><hr style="border:none;border-top:1px solid var(--border);margin:8px 0"/>`;
    box.appendChild(d);
  }
}

async function saveNote(){
  const title=$('note-title').value.trim();
  const body=$('note-body').value.trim();
  if(!title||!body){alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ —Ç–µ–∫—Å—Ç');return}
  const pwd=$('pass').value; if(pwd.length<6){alert('–°–Ω–∞—á–∞–ª–∞ –∑–∞–¥–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å –≤–≤–µ—Ä—Ö—É');return}
  const salt = crypto.getRandomValues(new Uint8Array(16));
  const baseKey = await crypto.subtle.importKey('raw', enc.encode(pwd), 'PBKDF2', false, ['deriveKey']);
  const key = await crypto.subtle.deriveKey({name:'PBKDF2', hash:'SHA-256', salt, iterations:150000}, baseKey, {name:'AES-GCM', length:256}, false, ['encrypt']);
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, enc.encode(body));
  const arr = store.get(NOTE_SLOT)||[];
  arr.unshift({ title, blob: b64u.enc(ct), iv: b64u.enc(iv), salt: b64u.enc(salt) });
  store.set(NOTE_SLOT, arr);
  $('note-title').value=''; $('note-body').value='';
  listNotes();
}

$('btn-save-note').onclick = saveNote;
$('btn-clear-notes').onclick = ()=>{ if(confirm('–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –∑–∞–º–µ—Ç–∫–∏?')){ store.del(NOTE_SLOT); listNotes(); } };

listNotes();
updateStatus();
</script>
</body>
</html>
